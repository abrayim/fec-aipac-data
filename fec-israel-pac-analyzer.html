<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro-Israel PAC Contribution Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #ffffff;
            --bg-card: #f8f9fa;
            --bg-hover: #f0f1f3;
            --bg-input: #ffffff;
            --border: #e0e3e7;
            --border-light: #eaecef;
            --text: #1a1d21;
            --text-secondary: #5a6068;
            --text-muted: #8c939b;
            --accent: #2563eb;
            --accent-dim: rgba(37, 99, 235, 0.08);
            --green: #16a34a;
            --green-dim: rgba(22, 163, 74, 0.08);
            --orange: #d97706;
            --orange-dim: rgba(217, 119, 6, 0.08);
            --red: #dc2626;
            --red-dim: rgba(220, 38, 38, 0.08);
            --purple: #7c3aed;
            --purple-dim: rgba(124, 58, 237, 0.08);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            min-height: 100vh;
        }

        .app-container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        .header {
            margin-bottom: 1.5rem;
        }

        .header h1 {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .about-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        .about-box strong { color: var(--text); }

        .about-box a {
            color: var(--accent);
            text-decoration: none;
        }

        .about-box a:hover { text-decoration: underline; }

        /* Search */
        .search-section { position: relative; margin-bottom: 1.5rem; }

        .search-row {
            display: flex;
            gap: 0.75rem;
            align-items: stretch;
        }

        .search-input {
            flex: 1;
            padding: 0.75rem 1rem;
            background: var(--bg-input);
            color: var(--text);
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.95rem;
            font-family: inherit;
            transition: border-color 0.15s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-dim);
        }

        .search-input::placeholder { color: var(--text-muted); }

        .search-btn {
            padding: 0.75rem 1.75rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            font-family: inherit;
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.15s;
        }

        .search-btn:hover:not(:disabled) { background: #1d4ed8; }
        .search-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
            z-index: 100;
            max-height: 280px;
            overflow-y: auto;
            margin-top: 4px;
        }

        .autocomplete-item {
            padding: 0.65rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border-light);
            transition: background 0.1s;
        }

        .autocomplete-item:hover { background: var(--bg-hover); }
        .autocomplete-item:last-child { border-bottom: none; }

        .candidate-name { font-weight: 600; font-size: 0.85rem; }
        .candidate-meta { color: var(--text-muted); font-size: 0.75rem; margin-top: 2px; }

        /* Stats grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem 1.25rem;
        }

        .stat-label {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .stat-value {
            font-size: 1.6rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-value.green { color: var(--green); }
        .stat-value.accent { color: var(--accent); }
        .stat-value.orange { color: var(--orange); }
        .stat-value.purple { color: var(--purple); }

        .stat-detail {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .latest-date {
            background: var(--green-dim);
            border: 1px solid rgba(22, 163, 74, 0.2);
            border-radius: 8px;
            padding: 0.6rem 1rem;
            margin-bottom: 1.5rem;
            font-size: 0.85rem;
            color: var(--green);
            font-weight: 500;
        }

        /* Table */
        .section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .section h2 {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .section-desc {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-bottom: 1rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.82rem;
        }

        th {
            text-align: left;
            padding: 0.5rem 0.6rem;
            border-bottom: 2px solid var(--border);
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.72rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            white-space: nowrap;
        }

        td {
            padding: 0.5rem 0.6rem;
            border-bottom: 1px solid var(--border-light);
        }

        .num { text-align: right; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; }

        .badge {
            display: inline-block;
            padding: 0.1rem 0.45rem;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .badge-blue { background: var(--accent-dim); color: var(--accent); }
        .badge-orange { background: var(--orange-dim); color: var(--orange); }
        .badge-green { background: var(--green-dim); color: var(--green); }
        .badge-purple { background: var(--purple-dim); color: var(--purple); }

        /* Collapsible sections */
        .collapsible-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            user-select: none;
            font-size: 0.82rem;
            font-weight: 500;
            color: var(--text-secondary);
            padding: 0.5rem 0;
        }

        .collapsible-toggle:hover { color: var(--text); }

        .pac-list {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            padding: 0.75rem 0;
            columns: 2;
            column-gap: 2rem;
        }

        .pac-list div { padding: 0.15rem 0; break-inside: avoid; }

        @media (max-width: 640px) {
            .pac-list { columns: 1; }
        }

        /* Status log */
        .log-container {
            background: #f6f6f6;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.75rem;
            margin-top: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .log-container .warn { color: var(--orange); }
        .log-container .error { color: var(--red); }
        .log-container .success { color: var(--green); }

        /* Other */
        .error-msg {
            background: var(--red-dim);
            border: 1px solid rgba(220,38,38,0.2);
            color: var(--red);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.85rem;
        }

        .warning-bar {
            background: var(--orange-dim);
            border: 1px solid rgba(217,119,6,0.2);
            color: #92400e;
            padding: 0.6rem 1rem;
            border-radius: 8px;
            font-size: 0.82rem;
            margin-bottom: 1rem;
        }

        .warning-bar a { color: inherit; text-decoration: underline; }

        .filter-stats {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.5rem 1rem;
            font-size: 0.78rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
            font-family: 'JetBrains Mono', monospace;
        }

        .footer-contact {
            border-top: 1px solid var(--border);
            margin-top: 2rem;
            padding-top: 1.5rem;
            font-size: 0.82rem;
            color: var(--text-muted);
            line-height: 1.7;
        }

        .footer-contact a {
            color: var(--accent);
            text-decoration: none;
        }

        .footer-contact a:hover { text-decoration: underline; }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-right: 0.5rem;
            vertical-align: middle;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        details summary { cursor: pointer; }
        details summary:hover { color: var(--text); }

        .detail-row {
            padding: 0.2rem 0;
            border-bottom: 1px solid var(--border-light);
        }

        .detail-row:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useRef, useCallback, useEffect } = React;

        // ═══════════════════════════════════════════════════════
        // 53 TRACKED PRO-ISRAEL PACS
        // Source: TrackAIPAC.com
        // ═══════════════════════════════════════════════════════
        const ISRAEL_PACS = {
            'C00797670': 'American Israel Public Affairs Committee PAC',
            'C00492579': 'American Principles',
            'C00687657': 'American Pro-Israel PAC',
            'C00138701': 'Americans for Good Government',
            'C00113019': 'Americans United in Support of Democracy',
            'C00155713': 'BAYPAC',
            'C00381624': 'Because I Care PAC',
            'C00204388': 'Bi-County PAC',
            'C00110585': 'Citizens Organized Political Action Committee',
            'C00187526': 'City PAC',
            'C00152579': 'Delaware Valley PAC',
            'C00429571': 'Democrats for Israel Committee',
            'C00710848': 'DMFI PAC (Democratic Majority for Israel)',
            'C00265470': 'Friends of Israel',
            'C00141747': 'Friends of Israel PAC / San Franciscans for Good Government',
            'C00169136': 'Garden State PAC',
            'C00473249': 'Grand Canyon State Caucus',
            'C00131557': 'Heartland PAC',
            'C00158865': 'Hudson Valley PAC',
            'C00557926': 'I-PAC JAX',
            'C00815753': 'J Street Action Fund',
            'C00139659': 'Joint Action Committee for Political Affairs',
            'C00441949': 'JStreetPAC',
            'C00144170': 'Louisianians for American Security PAC',
            'C00195024': 'Maryland Association for Concerned Citizens PAC',
            'C00165944': 'Mid Manhattan PAC',
            'C00199950': 'MOPAC',
            'C00189696': 'Multi-Issue PAC',
            'C00147983': 'National Action Committee',
            'C00150995': 'National PAC',
            'C00247403': 'NorPAC',
            'C00302414': 'Northwest PAC',
            'C00232611': 'PAC of Cherry Hill New Jersey',
            'C00878801': 'Preserve America PAC (Miriam Adelson)',
            'C00756882': 'Preserve America PAC (Sheldon Adelson)',
            'C00740936': 'Pro-Israel America Action Fund',
            'C00699470': 'Pro-Israel America PAC',
            'C90012063': 'Republican Jewish Coalition',
            'C00345132': 'Republican Jewish Coalition PAC (RJC-PAC)',
            'C00148155': 'St. Louisans for Better Government',
            'C00378216': 'SunPAC',
            'C00102368': 'The Desert Caucus',
            'C00135541': 'To Protect Our Heritage PAC',
            'C00799031': 'United Democracy Project (UDP)',
            'C00152280': 'United PAC (Illinois)',
            'C00127811': 'US Israel PAC / Florida Congressional Committee',
            'C00138560': 'Washington PAC',
            'C00203182': "Women's Pro-Israel National PAC",
            'C00236596': 'World Alliance for Israel PAC',
            'C00305607': 'Young Jewish Leadership PAC',
            'C00891259': 'Zioness PAC',
            'C00548628': 'Zionist Organization of America',
            'C00309781': 'Phoenix Education Partners'
        };

        const PAC_COUNT = Object.keys(ISRAEL_PACS).length;
        const API_KEY = 'mkiAiUz0a0Ion975USiQNN6l1Q2uzMWQeZJbfQvk';

        function FECAnalyzer() {
            const [searchText, setSearchText] = useState('');
            const [candidates, setCandidates] = useState([]);
            const [selectedCandidate, setSelectedCandidate] = useState(null);
            const [showAutocomplete, setShowAutocomplete] = useState(false);
            const [results, setResults] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [statusLog, setStatusLog] = useState([]);
            const [filterStats, setFilterStats] = useState(null);
            const [showPacList, setShowPacList] = useState(false);
            const [showLog, setShowLog] = useState(false);
            const [rateLimited, setRateLimited] = useState(false);
            const [latestDate, setLatestDate] = useState(null);

            const searchTimeout = useRef(null);
            const apiCallCount = useRef(0);

            const addStatus = useCallback((msg, type = 'info') => {
                const ts = new Date().toLocaleTimeString();
                setStatusLog(prev => [...prev, { msg, type, ts }]);
            }, []);

            // ── Candidate Search ──
            const searchCandidates = async (query) => {
                if (query.length < 2) { setCandidates([]); return; }
                try {
                    const resp = await fetch(`https://api.open.fec.gov/v1/candidates/search/?q=${encodeURIComponent(query)}&per_page=8&api_key=${API_KEY}`);
                    const data = await resp.json();
                    setCandidates(data.results || []);
                    setShowAutocomplete(true);
                } catch (e) {
                    setCandidates([]);
                }
            };

            const handleSearchInput = (val) => {
                setSearchText(val);
                setSelectedCandidate(null);
                if (searchTimeout.current) clearTimeout(searchTimeout.current);
                searchTimeout.current = setTimeout(() => searchCandidates(val), 300);
            };

            const selectCandidate = (c) => {
                setSelectedCandidate(c);
                setSearchText(c.name);
                setShowAutocomplete(false);
                setCandidates([]);
            };

            // ── Committee Lookup ──
            const getCommitteeIds = async (candidateId) => {
                addStatus(`Looking up committees for ${candidateId}...`);
                const resp = await fetch(`https://api.open.fec.gov/v1/candidate/${candidateId}/committees/?api_key=${API_KEY}&per_page=100`);
                apiCallCount.current++;
                const data = await resp.json();
                const ids = (data.results || []).map(c => c.committee_id);
                addStatus(`Found ${ids.length} committee(s): ${ids.join(', ')}`);
                return ids;
            };

            // ── Fetch contributions filtered by PAC contributor IDs (server-side) ──
            // Instead of fetching ALL contributions and filtering client-side,
            // we ask the FEC API to only return contributions from our tracked PACs.
            // This reduces 30,000+ rows down to a few hundred.
            const fetchPacContributions = async (committeeId, pacIds) => {
                const allResults = [];

                // Batch PAC IDs to keep URLs under length limits
                // ~20 IDs per batch keeps URLs well under 2000 chars
                const batchSize = 20;
                const batches = [];
                for (let i = 0; i < pacIds.length; i += batchSize) {
                    batches.push(pacIds.slice(i, i + batchSize));
                }

                for (let b = 0; b < batches.length; b++) {
                    const batch = batches[b];
                    const contributorParams = batch.map(id => `&contributor_id=${id}`).join('');

                    let retries = 0;
                    let lastIndex = null;
                    let lastDate = null;
                    let hasMore = true;
                    let page = 1;
                    const perPage = 100;

                    while (hasMore) {
                        let url = `https://api.open.fec.gov/v1/schedules/schedule_a/?committee_id=${committeeId}&per_page=${perPage}&api_key=${API_KEY}${contributorParams}`;

                        if (lastIndex && lastDate) {
                            url += `&last_index=${lastIndex}&last_contribution_receipt_date=${encodeURIComponent(lastDate)}`;
                        }

                        try {
                            const controller = new AbortController();
                            const timeout = setTimeout(() => controller.abort(), 30000);
                            const resp = await fetch(url, { signal: controller.signal });
                            clearTimeout(timeout);
                            apiCallCount.current++;

                            if (resp.status === 429 || resp.status === 502 || resp.status === 504) {
                                retries++;
                                const reason = resp.status === 429 ? 'Rate limited' : `Server timeout (${resp.status})`;
                                if (retries <= 3) {
                                    const waitSec = retries * 5;
                                    addStatus(`${reason} — waiting ${waitSec}s then retrying (attempt ${retries}/3)...`, 'warn');
                                    await new Promise(r => setTimeout(r, waitSec * 1000));
                                    continue;
                                }
                                addStatus(`${reason} after 3 retries — returning partial results`, 'warn');
                                setRateLimited(true);
                                hasMore = false;
                                break;
                            }
                            retries = 0;

                            if (!resp.ok) {
                                let errBody = '';
                                try { errBody = await resp.text(); } catch(e) {}
                                addStatus(`API error ${resp.status}: ${errBody.substring(0, 200)}`, 'error');
                                hasMore = false;
                                break;
                            }

                            const data = await resp.json();
                            const rows = data.results || [];
                            allResults.push(...rows);

                            if (page === 1 && rows.length > 0) {
                                addStatus(`${committeeId} batch ${b + 1}/${batches.length}: ${rows.length} rows (page 1)`);
                            }

                            const lastIndexes = data.pagination?.last_indexes;
                            if (!lastIndexes || !lastIndexes.last_index || rows.length < perPage) {
                                hasMore = false;
                            } else {
                                lastIndex = lastIndexes.last_index;
                                lastDate = lastIndexes.last_contribution_receipt_date;
                            }

                            if (hasMore) {
                                await new Promise(r => setTimeout(r, 250));
                            }

                            page++;
                        } catch (e) {
                            if (e.name === 'AbortError') {
                                retries++;
                                if (retries <= 3) {
                                    const waitSec = retries * 5;
                                    addStatus(`Request timed out — waiting ${waitSec}s then retrying (attempt ${retries}/3)...`, 'warn');
                                    await new Promise(r => setTimeout(r, waitSec * 1000));
                                    continue;
                                }
                                addStatus('Request timed out after 3 retries — returning partial results', 'warn');
                                setRateLimited(true);
                                hasMore = false;
                            } else {
                                addStatus(`Fetch error: ${e.message}`, 'error');
                                hasMore = false;
                            }
                        }
                    }

                    // Small delay between batches
                    if (b < batches.length - 1) {
                        await new Promise(r => setTimeout(r, 250));
                    }
                }

                return allResults;
            };

            // ── Main Analysis ──
            const runAnalysis = async () => {
                if (!selectedCandidate) return;

                setLoading(true);
                setError(null);
                setResults(null);
                setFilterStats(null);
                setStatusLog([]);
                setRateLimited(false);
                setLatestDate(null);
                apiCallCount.current = 0;

                try {
                    const committeeIds = await getCommitteeIds(selectedCandidate.candidate_id);
                    if (committeeIds.length === 0) {
                        throw new Error('No committees found for this candidate');
                    }

                    const pacIds = Object.keys(ISRAEL_PACS);
                    addStatus(`Searching ${committeeIds.length} committee(s) for contributions from ${pacIds.length} tracked PACs...`);

                    let allRaw = [];
                    for (const cid of committeeIds) {
                        addStatus(`Fetching from ${cid}...`);
                        const rows = await fetchPacContributions(cid, pacIds);
                        addStatus(`${cid}: ${rows.length.toLocaleString()} rows`, 'success');
                        allRaw.push(...rows);
                    }

                    addStatus(`Total rows fetched: ${allRaw.length.toLocaleString()}`);

                    // Filter: memo_code != 'X' (prevents double-counting)
                    const beforeMemo = allRaw.length;
                    const afterMemo = allRaw.filter(row => {
                        const mc = (row.memo_code || '').toString().trim().toUpperCase();
                        return mc !== 'X';
                    });
                    const memoExcluded = beforeMemo - afterMemo.length;
                    addStatus(`De-duplication: excluded ${memoExcluded.toLocaleString()} memo entries`, 'success');

                    // Verify contributor_id matches (should already match from server filter, but confirm)
                    const matched = afterMemo.filter(row => {
                        const cid = (row.contributor_id || '').toString().trim().toUpperCase();
                        return cid && ISRAEL_PACS[cid];
                    });

                    addStatus(`Verified: ${matched.length} contributions from tracked pro-Israel PACs`, 'success');
                    addStatus(`API calls used: ${apiCallCount.current}`, 'info');

                    const memoExcludedAmount = allRaw
                        .filter(row => (row.memo_code || '').toString().trim().toUpperCase() === 'X')
                        .reduce((s, r) => s + (parseFloat(r.contribution_receipt_amount) || 0), 0);

                    setFilterStats({
                        totalFetched: beforeMemo,
                        memoExcluded,
                        memoExcludedAmount,
                        afterMemo: afterMemo.length,
                        matched: matched.length,
                        apiCalls: apiCallCount.current
                    });

                    if (matched.length === 0) {
                        setError('No pro-Israel PAC contributions found for this candidate.');
                        setLoading(false);
                        return;
                    }

                    // Find latest transaction date
                    let maxDate = null;
                    matched.forEach(row => {
                        const d = row.contribution_receipt_date;
                        if (d && (!maxDate || d > maxDate)) maxDate = d;
                    });
                    setLatestDate(maxDate);

                    analyzeContributions(matched);

                } catch (err) {
                    addStatus(`Error: ${err.message}`, 'error');
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            // ── Group by PAC and Election Cycle ──
            const analyzeContributions = (contributions) => {
                const allYears = new Set();
                let totalAmount = 0;
                let bundledTotal = 0;
                let directTotal = 0;
                let bundledCount = 0;
                let directCount = 0;
                const byPac = {};

                contributions.forEach(row => {
                    const amount = parseFloat(row.contribution_receipt_amount) || 0;
                    const pacId = (row.contributor_id || '').trim().toUpperCase();
                    const pacName = ISRAEL_PACS[pacId] || pacId;
                    const entityType = (row.entity_type || '').trim().toUpperCase();

                    // Year: use two_year_transaction_period (election cycle)
                    let year = row.two_year_transaction_period
                        || row.fec_election_year
                        || null;
                    year = year ? String(year) : 'Unknown';
                    allYears.add(year);

                    const isBundled = entityType === 'IND';
                    const isDirect = entityType === 'PAC';

                    totalAmount += amount;
                    if (isBundled) { bundledTotal += amount; bundledCount++; }
                    if (isDirect) { directTotal += amount; directCount++; }

                    if (!byPac[pacId]) {
                        byPac[pacId] = {
                            pacId, pacName,
                            total: 0, bundled: 0, direct: 0,
                            bundledCount: 0, directCount: 0,
                            byYear: {}, rows: []
                        };
                    }
                    byPac[pacId].total += amount;
                    if (isBundled) { byPac[pacId].bundled += amount; byPac[pacId].bundledCount++; }
                    if (isDirect) { byPac[pacId].direct += amount; byPac[pacId].directCount++; }

                    if (!byPac[pacId].byYear[year]) {
                        byPac[pacId].byYear[year] = { bundled: 0, direct: 0, total: 0 };
                    }
                    byPac[pacId].byYear[year].total += amount;
                    if (isBundled) byPac[pacId].byYear[year].bundled += amount;
                    if (isDirect) byPac[pacId].byYear[year].direct += amount;

                    byPac[pacId].rows.push({
                        date: row.contribution_receipt_date || 'Unknown',
                        amount, entityType, year,
                        contributorName: row.contributor_name || '',
                        receiptType: row.receipt_type || ''
                    });
                });

                const sortedYears = Array.from(allYears).sort();
                const sortedPacs = Object.values(byPac).sort((a, b) => b.total - a.total);

                // Election cycle labels (e.g. 2024 → "2023–2024")
                const cycleLabel = (y) => {
                    const n = parseInt(y);
                    if (isNaN(n)) return y;
                    return `${n - 1}–${n}`;
                };

                setResults({
                    totalAmount, bundledTotal, directTotal,
                    bundledCount, directCount,
                    totalCount: contributions.length,
                    years: sortedYears, pacs: sortedPacs,
                    cycleLabel
                });
            };

            const fmt = (n) => new Intl.NumberFormat('en-US', {
                style: 'currency', currency: 'USD',
                minimumFractionDigits: 0, maximumFractionDigits: 0
            }).format(n);

            const fmtDate = (d) => {
                if (!d || d === 'Unknown') return '—';
                try { return new Date(d).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }); }
                catch { return d; }
            };

            // ═══════════════════════════════════
            // RENDER
            // ═══════════════════════════════════
            return (
                <div className="app-container">
                    <div className="header">
                        <h1>Pro-Israel PAC Contribution Analyzer</h1>
                        <p>Search any federal candidate to see how much they've received from {PAC_COUNT} tracked pro-Israel PACs.</p>
                    </div>

                    <div className="about-box">
                                <strong>Source:</strong> FEC Schedule A filings via the OpenFEC API.
                                This tool tracks contributions raised by candidates — it does not currently include independent expenditures
                                (money spent on behalf of or against a candidate, reported on Schedule E).
                                PAC list sourced from <a href="https://docs.google.com/spreadsheets/d/1h3JASnY_LJ3sOOvBeXkDExfiL5a8Mx_5Oy2hZrCn6TU/edit?gid=1515232731#gid=1515232731" target="_blank" rel="noopener">TrackAIPAC.com</a>.
                    </div>

                    {/* Search */}
                    <div className="search-section">
                        <div className="search-row">
                            <input
                                className="search-input"
                                placeholder="Type a candidate name (e.g. Pat Ryan, Josh Riley)..."
                                value={searchText}
                                onChange={e => handleSearchInput(e.target.value)}
                                onFocus={() => candidates.length > 0 && setShowAutocomplete(true)}
                                onBlur={() => setTimeout(() => setShowAutocomplete(false), 200)}
                            />
                            <button
                                className="search-btn"
                                onClick={runAnalysis}
                                disabled={!selectedCandidate || loading}
                            >
                                {loading ? <><span className="loading-spinner"></span>Analyzing...</> : 'Analyze'}
                            </button>
                        </div>

                        {showAutocomplete && candidates.length > 0 && (
                            <div className="autocomplete-list">
                                {candidates.map(c => (
                                    <div key={c.candidate_id} className="autocomplete-item"
                                        onMouseDown={() => selectCandidate(c)}>
                                        <div className="candidate-name">{c.name}</div>
                                        <div className="candidate-meta">
                                            {c.office_full || c.office} · {c.state}-{c.district || 'At Large'} · {c.party_full || c.party}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* PAC list toggle */}
                    <div style={{marginBottom: '1rem'}}>
                        <div className="collapsible-toggle" onClick={() => setShowPacList(!showPacList)}>
                            <span>{showPacList ? '▾' : '▸'}</span>
                            <span>View tracked PACs ({PAC_COUNT})</span>
                        </div>
                        {showPacList && (
                            <div className="pac-list">
                                {Object.entries(ISRAEL_PACS).map(([id, name]) => (
                                    <div key={id}>{name}</div>
                                ))}
                            </div>
                        )}
                    </div>

                    {error && <div className="error-msg">{error}</div>}

                    {rateLimited && (
                        <div className="warning-bar">
                            ⚠ Results may be incomplete due to API rate limits. Some contribution data may be missing.
                        </div>
                    )}

                    {/* Results */}
                    {results && (
                        <>
                            {/* Latest transaction date */}
                            {latestDate && (
                                <div className="latest-date">
                                    Latest reported transaction: {fmtDate(latestDate)}
                                </div>
                            )}

                            {/* Summary cards */}
                            <div className="stats-grid">
                                <div className="stat-card">
                                    <div className="stat-label">Total Raised from Pro-Israel PACs</div>
                                    <div className="stat-value green">{fmt(results.totalAmount)}</div>
                                    <div className="stat-detail">{results.totalCount} contributions</div>
                                </div>
                                <div className="stat-card">
                                    <div className="stat-label">Bundled Individual Contributions</div>
                                    <div className="stat-value accent">{fmt(results.bundledTotal)}</div>
                                    <div className="stat-detail">{results.bundledCount} contributions routed through PACs</div>
                                </div>
                                <div className="stat-card">
                                    <div className="stat-label">Direct PAC Contributions</div>
                                    <div className="stat-value orange">{fmt(results.directTotal)}</div>
                                    <div className="stat-detail">{results.directCount} contributions from PAC treasury funds</div>
                                </div>
                                <div className="stat-card">
                                    <div className="stat-label">PACs Contributing</div>
                                    <div className="stat-value purple">{results.pacs.length}</div>
                                    <div className="stat-detail">of {PAC_COUNT} tracked</div>
                                </div>
                            </div>

                            {/* Breakdown table */}
                            <div className="section">
                                <h2>Breakdown by PAC and Election Cycle</h2>
                                <div className="section-desc">
                                    <span className="badge badge-blue" style={{marginRight: '0.5rem'}}>Bundled Individual</span>
                                    <span className="badge badge-orange">Direct PAC</span>
                                </div>
                                <div style={{overflowX: 'auto'}}>
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>PAC</th>
                                                <th>Type</th>
                                                {results.years.map(y => <th key={y} className="num">{results.cycleLabel(y)}</th>)}
                                                <th className="num">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {results.pacs.map(pac => (
                                                <React.Fragment key={pac.pacId}>
                                                    {pac.bundledCount > 0 && (
                                                        <tr>
                                                            <td style={{maxWidth: '250px'}}>
                                                                <div style={{fontWeight: 600, fontSize: '0.82rem'}}>{pac.pacName}</div>
                                                                <div style={{color: 'var(--text-muted)', fontSize: '0.7rem', fontFamily: "'JetBrains Mono', monospace"}}>{pac.pacId}</div>
                                                            </td>
                                                            <td><span className="badge badge-blue">IND</span></td>
                                                            {results.years.map(y => (
                                                                <td key={y} className="num">
                                                                    {pac.byYear[y]?.bundled ? fmt(pac.byYear[y].bundled) : '—'}
                                                                </td>
                                                            ))}
                                                            <td className="num" style={{fontWeight: 700, color: 'var(--accent)'}}>
                                                                {fmt(pac.bundled)}
                                                            </td>
                                                        </tr>
                                                    )}
                                                    {pac.directCount > 0 && (
                                                        <tr>
                                                            <td style={{maxWidth: '250px'}}>
                                                                {pac.bundledCount === 0 && (
                                                                    <>
                                                                        <div style={{fontWeight: 600, fontSize: '0.82rem'}}>{pac.pacName}</div>
                                                                        <div style={{color: 'var(--text-muted)', fontSize: '0.7rem', fontFamily: "'JetBrains Mono', monospace"}}>{pac.pacId}</div>
                                                                    </>
                                                                )}
                                                            </td>
                                                            <td><span className="badge badge-orange">PAC</span></td>
                                                            {results.years.map(y => (
                                                                <td key={y} className="num">
                                                                    {pac.byYear[y]?.direct ? fmt(pac.byYear[y].direct) : '—'}
                                                                </td>
                                                            ))}
                                                            <td className="num" style={{fontWeight: 700, color: 'var(--orange)'}}>
                                                                {fmt(pac.direct)}
                                                            </td>
                                                        </tr>
                                                    )}
                                                    {pac.bundledCount > 0 && pac.directCount > 0 && (
                                                        <tr style={{borderBottom: '2px solid var(--border)'}}>
                                                            <td style={{fontStyle: 'italic', color: 'var(--text-muted)', fontSize: '0.8rem'}}>Subtotal</td>
                                                            <td></td>
                                                            {results.years.map(y => (
                                                                <td key={y} className="num" style={{fontWeight: 600}}>
                                                                    {pac.byYear[y]?.total ? fmt(pac.byYear[y].total) : '—'}
                                                                </td>
                                                            ))}
                                                            <td className="num" style={{fontWeight: 700, color: 'var(--green)'}}>
                                                                {fmt(pac.total)}
                                                            </td>
                                                        </tr>
                                                    )}
                                                </React.Fragment>
                                            ))}
                                            {/* Grand total */}
                                            <tr style={{borderTop: '3px solid var(--border)'}}>
                                                <td style={{fontWeight: 700, fontSize: '0.9rem'}}>Grand Total</td>
                                                <td></td>
                                                {results.years.map(y => {
                                                    const yearTotal = results.pacs.reduce((s, p) => s + (p.byYear[y]?.total || 0), 0);
                                                    return <td key={y} className="num" style={{fontWeight: 700}}>{yearTotal ? fmt(yearTotal) : '—'}</td>;
                                                })}
                                                <td className="num" style={{fontWeight: 700, fontSize: '1rem', color: 'var(--green)'}}>
                                                    {fmt(results.totalAmount)}
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            {/* Transaction Details */}
                            <div className="section">
                                <h2>Transaction Details</h2>
                                <div className="section-desc">Individual contributions sorted by date (most recent first)</div>
                                {results.pacs.map(pac => (
                                    <details key={pac.pacId} style={{marginBottom: '0.75rem'}}>
                                        <summary style={{padding: '0.5rem 0', fontWeight: 600, fontSize: '0.9rem', color: 'var(--text-secondary)'}}>
                                            {pac.pacName} — {fmt(pac.total)} ({pac.bundledCount + pac.directCount} contributions)
                                        </summary>
                                        <div style={{paddingLeft: '1rem', marginTop: '0.25rem'}}>
                                            {pac.rows.sort((a, b) => {
                                                if (a.date === 'Unknown') return 1;
                                                if (b.date === 'Unknown') return -1;
                                                return b.date.localeCompare(a.date);
                                            }).map((row, i) => (
                                                <div key={i} className="detail-row" style={{display: 'flex', gap: '1rem', alignItems: 'center', padding: '0.3rem 0'}}>
                                                    <span style={{width: '90px', color: 'var(--text-muted)', fontSize: '0.75rem', fontFamily: "'JetBrains Mono', monospace"}}>
                                                        {fmtDate(row.date)}
                                                    </span>
                                                    <span className={`badge ${row.entityType === 'IND' ? 'badge-blue' : 'badge-orange'}`}>
                                                        {row.entityType === 'IND' ? 'IND' : 'PAC'}
                                                    </span>
                                                    <span style={{fontFamily: "'JetBrains Mono', monospace", fontWeight: 600, fontSize: '0.85rem', minWidth: '80px'}}>
                                                        {fmt(row.amount)}
                                                    </span>
                                                    <span style={{color: 'var(--text-muted)', fontSize: '0.75rem', flex: 1}}>
                                                        {row.contributorName}
                                                    </span>
                                                </div>
                                            ))}
                                        </div>
                                    </details>
                                ))}
                            </div>

                            {/* Source note */}
                            <div className="about-box">
                                <strong>Source:</strong> FEC Schedule A filings via the OpenFEC API.
                                This tool tracks contributions raised by candidates — it does not currently include independent expenditures
                                (money spent on behalf of or against a candidate, reported on Schedule E).
                                PAC list sourced from <a href="https://trackaipac.com" target="_blank" rel="noopener">TrackAIPAC.com</a>.
                            </div>
                        </>
                    )}

                    {/* Debug log — collapsible */}
                    {statusLog.length > 0 && (
                        <div style={{marginTop: '1rem'}}>
                            <div className="collapsible-toggle" onClick={() => setShowLog(!showLog)}>
                                <span>{showLog ? '▾' : '▸'}</span>
                                <span>Debug log ({statusLog.length} entries) — {filterStats ? `${filterStats.apiCalls} API calls` : ''}</span>
                            </div>
                            {showLog && (
                                <div className="log-container">
                                    {statusLog.map((s, i) => (
                                        <div key={i} className={s.type}>
                                            [{s.ts}] {s.msg}
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}

                    {/* Instructions (shown when no results) */}
                    {!results && !loading && !error && (
                        <div className="about-box" style={{marginTop: '1rem'}}>
                            <strong>Getting started:</strong> Type a candidate's name in the search box above and select them
                            from the dropdown. Click "Analyze" to pull their contribution data from the FEC. The analysis may
                            take a minute or two for candidates with large fundraising histories.
                        </div>
                    )}

                    {/* Footer */}
                    <div className="footer-contact">
                        <strong>About this tool:</strong> Built to make pro-Israel PAC contributions to federal candidates
                        more transparent and accessible. Data comes directly from FEC filings. The list of {PAC_COUNT} tracked
                        PACs is sourced from <a href="https://docs.google.com/spreadsheets/d/1h3JASnY_LJ3sOOvBeXkDExfiL5a8Mx_5Oy2hZrCn6TU/edit?gid=1515232731#gid=1515232731" target="_blank" rel="noopener">TrackAIPAC.com</a>.
                        <br/><br/>
                        Questions, issues, or feedback? Contact: <strong>admin@yourreprecord.org</strong>
                        <br/>
                        <span style={{fontSize: '0.75rem', color: 'var(--text-muted)'}}>
                            This tool is for informational purposes only. Always verify data against official FEC records at{' '}
                            <a href="https://www.fec.gov" target="_blank" rel="noopener">fec.gov</a>.
                        </span>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<FECAnalyzer />, document.getElementById('root'));
    </script>
</body>
</html>
